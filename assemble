#!/bin/bash +x
# assemble
#Assembles nultiple binary files into one at known/specified Offsets
# 
# usage:
#  assemble [OUTPUT] [OFFSET]:[INPUT1] [OFFSET]:[INPUT] ...
#  assemble -r [REASSEMBLYFILE] [OUTPUT]
#  -r, --reassemble   use reasssemblyfile as input(can be generated by extract.sh)
#
# example:
#  ./assemble output.bin 0:input1.bin 0x1000:input2.bin
#  ./assemble -r reassembly.txt output.bin


if [[ "$1" == "-r" || "$1" == "--reassembly" ]]; then
  DST=$3
  read -a ARGS < "$2"
else
  DST=$1
  shift
  ARGS=("$@")
fi

rm -rf $DST

for arg in "${ARGS[@]}"
do
  IFS=\: read -a fields <<<"$arg"
  SRC=${fields[1]} 
  OFFSET=$((${fields[0]})) 

  dd if=$SRC of=$DST bs=1 seek=$OFFSET conv=notrunc
done
